# 系统日志管理JSP流程

本文档详细描述了从用户请求到JSP页面展示的系统日志管理完整流程，包括涉及的类文件和方法。

## 1. 流程概述

```
用户请求 → 控制器 → 服务层 → DAO层 → 数据库 → DAO层 → 服务层 → 控制器 → JSP模板 → 用户展示
```

## 2. 详细流程分析

### 2.1 用户请求阶段

用户访问URL：`http://localhost:8080/admin/logs`
方法：HTTP GET
参数：无(默认显示日志列表)

### 2.2 控制层 (Controller)

**文件**: `src/main/java/com/insurance/controller/SystemLogServlet.java`

**关键方法**:
- `doGet()` - 处理GET请求
- `showLogList()` - 显示日志列表
- `searchLogs()` - 搜索日志
- `showStatistics()` - 显示统计信息

**核心代码**:
```java
@WebServlet("/admin/logs")
public class SystemLogServlet extends HttpServlet {
    private SystemLogService logService;
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        String action = request.getParameter("action");
        if ("view".equals(action)) {
            viewLogDetail(request, response);
        } else if ("search".equals(action)) {
            searchLogs(request, response);
        } else if ("statistics".equals(action)) {
            showStatistics(request, response);
        } else {
            showLogList(request, response);
        }
    }
    
    private void showLogList(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        List<SystemLog> logs = logService.getAllLogs();
        request.setAttribute("logs", logs);
        request.setAttribute("totalCount", logService.getTotalLogCount());
        request.getRequestDispatcher("/WEB-INF/views/admin/logs.jsp").forward(request, response);
    }
}
```

### 2.3 服务层 (Service)

**文件**: `src/main/java/com/insurance/service/SystemLogService.java`

**关键方法**:
- `getAllLogs()` - 获取所有日志列表
- `searchLogs()` - 根据条件搜索日志
- `getLogStatistics()` - 获取日志统计信息

**核心代码**:
```java
public class SystemLogService {
    private SystemLogDAO systemLogDAO;
    
    public List<SystemLog> getAllLogs() {
        return systemLogDAO.getAllLogs();
    }
    
    public List<SystemLog> searchLogs(String level, String module, String keyword, 
                                    Date startDate, Date endDate) {
        return systemLogDAO.searchLogs(level, module, keyword, startDate, endDate);
    }
    
    public List<Object[]> getLogStatistics() {
        return systemLogDAO.getLogStatistics();
    }
}
```

### 2.4 数据访问层 (DAO)

**文件**: `src/main/java/com/insurance/dao/SystemLogDAO.java`

**关键方法**:
- `getAllLogs()` - 从数据库获取所有日志
- `searchLogs()` - 根据条件搜索日志
- `getLogStatistics()` - 获取日志统计信息
- `mapResultSetToLog()` - 将结果集映射到SystemLog对象

**核心代码**:
```java
public class SystemLogDAO {
    public List<SystemLog> getAllLogs() {
        List<SystemLog> logs = new ArrayList<>();
        String sql = "SELECT * FROM system_logs ORDER BY log_time DESC";
        
        try (Connection conn = DatabaseUtil.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql);
             ResultSet rs = pstmt.executeQuery()) {
            
            while (rs.next()) {
                logs.add(mapResultSetToLog(rs));
            }
        } catch (SQLException e) {
            System.err.println("获取所有系统日志失败: " + e.getMessage());
        }
        return logs;
    }
    
    private SystemLog mapResultSetToLog(ResultSet rs) throws SQLException {
        SystemLog log = new SystemLog();
        log.setId(rs.getInt("id"));
        log.setLogLevel(rs.getString("log_level"));
        log.setLogMessage(rs.getString("log_message"));
        log.setModule(rs.getString("module"));
        log.setUsername(rs.getString("username"));
        log.setIpAddress(rs.getString("ip_address"));
        log.setLogTime(rs.getTimestamp("log_time"));
        log.setRequestId(rs.getString("request_id"));
        log.setSessionId(rs.getString("session_id"));
        log.setUserAgent(rs.getString("user_agent"));
        return log;
    }
}
```

### 2.5 模型层 (Model)

**文件**: `src/main/java/com/insurance/model/SystemLog.java`

**关键字段**:
- id - 日志ID
- logLevel - 日志级别
- logMessage - 日志消息
- module - 模块名称
- username - 用户名
- ipAddress - IP地址
- logTime - 日志时间

### 2.6 数据库层

**表名**: `system_logs`

**关键字段**:
- id (主键)
- log_level (日志级别)
- log_message (日志消息)
- module (模块名称)
- username (用户名)
- ip_address (IP地址)
- log_time (日志时间)
- request_id (请求ID)
- session_id (会话ID)
- user_agent (用户代理)

### 2.7 JSP视图层

**文件**: `src/main/webapp/WEB-INF/views/admin/logs.jsp`

**关键代码**:
```jsp
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<!-- 日志列表表格 -->
<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>时间</th>
                <th>级别</th>
                <th>模块</th>
                <th>消息</th>
                <th>用户</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <c:forEach var="log" items="${logs}">
                <tr class="log-level-${log.logLevel.toLowerCase()}">
                    <td><fmt:formatDate value="${log.logTime}" pattern="yyyy-MM-dd HH:mm:ss" /></td>
                    <td>
                        <span class="badge badge-${log.logLevel.toLowerCase()}">
                            ${log.logLevel}
                        </span>
                    </td>
                    <td>${log.module}</td>
                    <td class="log-message">
                        <c:choose>
                            <c:when test="${fn:length(log.logMessage) > 100}">
                                ${fn:substring(log.logMessage, 0, 100)}...
                            </c:when>
                            <c:otherwise>
                                ${log.logMessage}
                            </c:otherwise>
                        </c:choose>
                    </td>
                    <td>${not empty log.username ? log.username : '系统'}</td>
                    <td>
                        <a href="${pageContext.request.contextPath}/admin/logs?action=view&id=${log.id}" 
                           class="btn btn-sm btn-info">详细</a>
                    </td>
                </tr>
            </c:forEach>
        </tbody>
    </table>
</div>
```

## 3. 流程总结

1. **用户请求**: 用户访问`/admin/logs`
2. **控制器处理**: `SystemLogServlet.doGet()`接收请求，调用`showLogList()`方法
3. **服务层调用**: `SystemLogService.getAllLogs()`获取日志列表
4. **数据访问**: `SystemLogDAO.getAllLogs()`查询数据库并映射为SystemLog对象列表
5. **数据返回**: 数据逐层返回到控制器
6. **JSP渲染**: 控制器将数据放入request属性并通过`RequestDispatcher`转发到`logs.jsp`
7. **页面展示**: JSP页面使用JSTL标签渲染数据并返回给用户浏览器显示

这个流程展示了典型的MVC架构在传统JSP应用中的应用，数据从数据库通过DAO、Service、Controller层层传递，最终通过JSP页面渲染展示给用户。