# 安全认证和权限管理流程

## 1. 用户登录认证流程

### 1.1 登录请求处理流程

```
用户浏览器 → 登录页面 (/login.jsp) → AuthController.doGet() → 生成CSRF令牌 → 显示登录表单
```

### 1.2 登录验证流程

```
用户提交表单 → AuthController.doPost() → CSRF令牌验证 → 参数验证 → AuthUtil.authenticate() → 
UserService.getUserByUsername() → UserDAO.getUserByUsername() → 数据库验证 → 
密码加密验证 (SHA-256) → 会话创建 → 登录日志记录 → 重定向到对应角色页面
```

### 1.3 安全特性
- **CSRF防护**: 所有表单提交必须包含有效的CSRF令牌
- **密码加密**: 使用SHA-256算法加密存储密码
- **会话管理**: 30分钟会话超时，自动更新活动时间
- **登录限制**: 5次失败尝试后账户锁定30分钟
- **IP记录**: 记录登录IP地址用于审计

## 2. 权限验证流程

### 2.1 安全过滤器流程 (SecurityFilter.doFilter())

```
请求到达 → 设置安全响应头 → 检查公共路径 → 检查用户登录状态 → 检查会话超时 → 
更新会话活动时间 → 检查路径权限 → 检查CSRF令牌 (POST/PUT/DELETE) → 
防止会话固定攻击 → 继续处理请求
```

### 2.2 权限检查层次

1. **公共路径**: 无需认证 (CSS/JS/图片/登录页面)
2. **管理员路径**: 需要ADMIN角色 (/admin/, /batch/, /logs/, /monitor/)
3. **销售员路径**: 需要SALES角色 (/customer/, /contract/, /premium/)
4. **审查员路径**: 需要REVIEWER角色 (/contract/review/, /claim/)
5. **用户路径**: 需要USER角色 (/mypage/)

### 2.3 权限验证方法

```java
// 检查角色权限
AuthUtil.hasPermission(request, "ADMIN")

// 检查模块访问权限  
AuthUtil.hasModuleAccess(request, "CUSTOMER")
```

## 3. 用户管理流程

### 3.1 用户创建流程

```
管理员请求 → UserManagementController → 权限验证 (ADMIN) → CSRF验证 → 
参数验证 (用户名唯一性、邮箱格式、密码强度) → 密码加密 → 创建用户记录 → 日志记录
```

### 3.2 密码强度要求
- 长度: 8-20字符
- 必须包含: 大写字母、小写字母、数字
- 使用SHA-256加密存储

### 3.3 账户状态管理
- **正常**: 可正常登录
- **已禁用**: 管理员手动禁用
- **已锁定**: 登录失败次数超过限制
- **自动解锁**: 锁定30分钟后自动解锁

## 4. 会话安全管理

### 4.1 会话生命周期

```
登录成功 → 创建会话 (设置user、loginTime、userRole) → 
每次请求 → 更新会话活动时间 → 30分钟无活动 → 会话超时 → 自动登出
```

### 4.2 安全防护措施

1. **会话固定防护**: 登录成功后重新生成会话ID
2. **CSRF防护**: 所有状态修改操作需要CSRF令牌
3. **安全响应头**: 设置XSS防护、点击劫持防护等
4. **输入验证**: 所有用户输入进行验证和过滤

## 5. 审计日志流程

### 5.1 安全事件记录

```
登录成功/失败 → LogUtil.info()/warn() → SystemLogService → SystemLogDAO → 数据库记录
权限验证失败 → 记录访问拒绝日志
用户管理操作 → 记录操作详情和执行者
```

### 5.2 日志信息包含
- 操作类型 (登录、权限验证、用户管理)
- 操作结果 (成功/失败)
- 用户信息 (用户名、角色)
- IP地址
- 时间戳
- 详细错误信息

## 6. 异常处理流程

### 6.1 权限不足处理

```
权限检查失败 → SecurityFilter → 返回403错误 → AccessDeniedController → 显示拒绝访问页面
```

### 6.2 会话超时处理

```
会话超时 → SecurityFilter → 重定向到登录页面 → 显示超时提示 → 需要重新登录
```

### 6.3 CSRF验证失败

```
CSRF令牌不匹配 → SecurityFilter/AuthController → 返回403错误 → 记录安全事件
```

## 7. 数据库安全设计

### 7.1 用户表结构安全
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(20) UNIQUE NOT NULL,
    password VARCHAR(64) NOT NULL, -- SHA-256哈希值
    email VARCHAR(100) UNIQUE NOT NULL,
    role ENUM('ADMIN','SALES','REVIEWER','USER') NOT NULL,
    active BOOLEAN DEFAULT true,
    login_attempts INT DEFAULT 0,
    account_locked_until TIMESTAMP NULL,
    last_login TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted BOOLEAN DEFAULT false,
    created_by VARCHAR(20),
    updated_by VARCHAR(20)
);
```

### 7.2 安全索引
- username唯一索引
- email唯一索引  
- role索引用于快速权限查询
- active索引用于状态过滤

## 8. API安全设计

### 8.1 REST API安全
```
API请求 → ApiBaseServlet → 权限验证 → 参数验证 → 业务处理 → 返回JSON响应
```

### 8.2 安全响应头
```java
response.setHeader("X-Content-Type-Options", "nosniff");
response.setHeader("X-Frame-Options", "DENY");
response.setHeader("X-XSS-Protection", "1; mode=block");
response.setHeader("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
response.setHeader("Content-Security-Policy", "default-src 'self'");
```

## 9. 部署安全考虑

### 9.1 环境配置
- 数据库连接使用加密配置
- 生产环境禁用调试信息
- 定期更新安全补丁

### 9.2 监控告警
- 监控异常登录尝试
- 监控权限验证失败
- 监控系统健康状态

## 10. 应急响应流程

### 10.1 安全事件响应
1. 识别安全事件 (异常登录、权限绕过等)
2. 立即阻止攻击 (临时禁用账户、IP封锁)
3. 调查事件原因 (分析日志、追溯操作)
4. 修复安全漏洞 (代码修复、配置调整)
5. 恢复系统正常 (解除限制、验证修复)

### 10.2 数据备份恢复
- 定期备份用户数据和日志
- 建立灾难恢复预案
- 测试恢复流程有效性

---

**总结**: 本系统采用多层次的安全防护体系，包括身份认证、权限控制、会话管理、输入验证、日志审计等多个安全层面，确保系统在各种场景下的安全性。