# 系统监控和日志管理

## 1. 系统架构概述

系统监控和日志管理模块采用分层架构设计，包含以下核心组件：

- **监控层**：SystemMonitor.java - 实时监控系统性能
- **模型层**：SystemLog.java - 日志数据模型
- **数据访问层**：SystemLogDAO.java - 数据库操作
- **业务层**：SystemLogService.java - 业务逻辑处理
- **控制层**：SystemLogServlet.java / SystemMonitorServlet.java - HTTP请求处理
- **视图层**：logs.jsp, monitor.jsp等 - 管理界面

## 2. 核心功能模块

### 2.1 系统监控模块 (SystemMonitor.java)

**主要功能：**
- 实时监控CPU、内存、磁盘使用情况
- 数据库连接状态检查
- 系统健康状态监控
- 自动监控调度（每5分钟监控，每小时详细检查）

**监控指标：**
- 内存使用率（堆内存/非堆内存）
- CPU系统负载
- 磁盘剩余空间
- 数据库连接状态
- JVM运行时间、线程数、加载类数

### 2.2 日志管理模块

#### 2.2.1 日志记录 (LogUtil.java)
- 多级别日志记录：INFO, WARN, ERROR, DEBUG
- 文件日志和控制台输出
- 自动日志文件轮转（每日）

#### 2.2.2 日志模型 (SystemLog.java)
```java
public class SystemLog {
    private int id;                    // 日志ID
    private String logLevel;          // 日志级别
    private String logMessage;        // 日志消息
    private String module;            // 模块名称
    private String username;         // 用户名
    private String ipAddress;        // IP地址
    private Date logTime;            // 记录时间
    private String requestId;        // 请求ID
    private String sessionId;        // 会话ID
    private String userAgent;        // 用户代理
}
```

#### 2.2.3 数据访问层 (SystemLogDAO.java)
- 日志CRUD操作
- 高级搜索和过滤功能
- 统计信息和报表生成
- 旧日志自动清理

#### 2.2.4 业务服务层 (SystemLogService.java)
- 用户操作日志记录
- 错误日志管理
- 日志统计和分析
- 模块使用统计

## 3. 数据库设计

### 3.1 系统日志表 (system_logs)
```sql
CREATE TABLE system_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    log_level VARCHAR(10) NOT NULL,      -- 日志级别
    log_message TEXT NOT NULL,           -- 日志消息
    module VARCHAR(50),                  -- 模块名称
    username VARCHAR(50),                -- 用户名
    ip_address VARCHAR(45),              -- IP地址
    log_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 记录时间
    request_id VARCHAR(100),             -- 请求ID
    session_id VARCHAR(100),             -- 会话ID
    user_agent TEXT,                     -- 用户代理
    INDEX idx_log_level (log_level),
    INDEX idx_module (module),
    INDEX idx_log_time (log_time),
    INDEX idx_username (username)
);
```

## 4. 管理界面功能

### 4.1 日志管理界面 (logs.jsp)
- 日志列表查看
- 高级搜索功能（按级别、模块、关键词、时间范围）
- 分页显示
- 批量操作

### 4.2 日志详情界面 (log-detail.jsp)
- 单个日志的详细信息展示
- 相关上下文信息

### 4.3 统计信息界面 (log-statistics.jsp)
- 日志级别分布统计
- 模块使用统计
- 时间趋势分析

### 4.4 系统监控面板 (monitor.jsp)
- 实时系统状态显示
- 性能指标图表
- 健康状态检查

## 5. API接口

### 5.1 日志管理API
```
GET  /admin/logs           # 获取日志列表
GET  /admin/logs?action=search&level=ERROR&module=USER  # 搜索日志
GET  /admin/logs?action=detail&id=123    # 获取日志详情
GET  /admin/logs?action=statistics       # 获取统计信息
POST /admin/logs?action=cleanup&days=30  # 清理旧日志
```

### 5.2 系统监控API
```
GET  /admin/monitor          # 获取系统状态
GET  /admin/monitor?action=report  # 获取详细报告
POST /admin/monitor?action=check   # 手动触发系统检查
```

## 6. 执行流程示例

### 6.1 用户查看日志列表流程
```
1. 浏览器请求: GET /admin/logs
2. SystemLogServlet.doGet() 接收请求
3. 调用 SystemLogService.getAllLogs()
4. SystemLogDAO.getAllLogs() 执行数据库查询
5. 返回 List<SystemLog> 数据
6. JSP页面 (logs.jsp) 渲染数据
7. 返回HTML响应给用户
```

### 6.2 系统监控执行流程
```
1. 应用启动时 SystemMonitor.startMonitoring() 自动执行
2. 每5分钟执行 monitorSystem() 方法
3. 监控内存、CPU、磁盘、数据库连接
4. 记录监控结果到系统日志
5. 管理员可通过 monitor.jsp 查看实时状态
```

## 7. 安全考虑

- 日志记录包含用户IP和操作信息
- 敏感信息过滤和脱敏
- 访问权限控制（仅管理员可访问）
- 日志数据加密存储

## 8. 性能优化

- 数据库索引优化
- 日志查询分页处理
- 监控数据缓存
- 异步日志记录

## 9. 扩展性设计

- 支持自定义监控指标
- 可配置的日志级别
- 模块化的监控插件
- 支持多种日志输出格式

## 10. 运维管理

- 日志自动轮转和清理
- 监控告警阈值配置
- 系统健康检查报告
- 性能趋势分析

此文档基于项目实际代码库分析编写，反映了当前系统的监控和日志管理架构。所有功能已在代码中实现并可通过管理界面访问。