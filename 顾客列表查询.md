# ✅ 顾客列表查询

以"顾客列表查询"为例，详细说明从用户请求到页面响应的完整执行流程：

第 1 步：用户请求 (浏览器)

文件： 无（浏览器发起请求）
URL： http://localhost:8080/customer?action=list
方法： HTTP GET
参数： action=list

第 2 步：Servlet 控制器层

文件： src/main/java/com/insurance/controller/CustomerServlet.java

2.1 请求接收和路由

```java
// CustomerServlet.java:29-30 (doGet 方法)
protected void doGet(HttpServletRequest request, HttpServletResponse response)
throws ServletException, IOException {

      String action = request.getParameter("action"); // 获取action参数，值为"list"

      if (action == null) {
          action = "list"; // 默认为list
      }

      switch (action) {
          case "list":
              listCustomers(request, response); // 调用listCustomers方法
              break;
          // ... 其他case
      }

}
```

2.2 调用业务逻辑

```java
// CustomerServlet.java:95-103 (listCustomers 方法)
private void listCustomers(HttpServletRequest request, HttpServletResponse response)
throws ServletException, IOException {

      // 调用Service层获取所有顾客数据
      List<Customer> customers = customerService.getAllCustomers();

      // 将数据存入request作用域
      request.setAttribute("customers", customers);

      // 转发到JSP页面进行渲染

      RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/customer/list.jsp");
      dispatcher.forward(request, response);

}
```

第 3 步：Service 业务逻辑层

文件： src/main/java/com/insurance/service/CustomerService.java

3.1 业务逻辑处理

```java
// CustomerService.java:32-34 (getAllCustomers 方法)
public List<Customer> getAllCustomers() {
// 直接调用 DAO 层获取数据，这里主要是业务逻辑验证
return customerDAO.getAllCustomers();
}
```

第 4 步：DAO 数据访问层

文件： src/main/java/com/insurance/dao/CustomerDAO.java

4.1 数据库连接

```java
// CustomerDAO.java:57-72 (getAllCustomers 方法)
public List<Customer> getAllCustomers() {
List<Customer> customers = new ArrayList<>();
String sql = "SELECT \* FROM customers WHERE deleted_flag = 0 ORDER BY created_at DESC";

      // 获取数据库连接
      try (Connection conn = DatabaseUtil.getConnection();
           Statement stmt = conn.createStatement();
           ResultSet rs = stmt.executeQuery(sql)) {

          // 遍历结果集，转换为Customer对象
          while (rs.next()) {
              customers.add(mapResultSetToCustomer(rs));
          }
      } catch (SQLException e) {
          e.printStackTrace();
      }
      return customers;

}
```

4.2 数据库连接工具

文件： src/main/java/com/insurance/util/DatabaseUtil.java

```java
// DatabaseUtil.java:28-38 (getConnection 方法)
public static Connection getConnection() throws SQLException {
Properties props = new Properties();
props.setProperty("user", DB_USER); // 数据库用户名
props.setProperty("password", DB_PASSWORD); // 数据库密码
props.setProperty("useSSL", "false");
props.setProperty("characterEncoding", "UTF-8");
props.setProperty("useUnicode", "true");
props.setProperty("serverTimezone", "Asia/Tokyo");

      // 返回数据库连接对象
      return DriverManager.getConnection(DB_URL, props);

}
```

第 5 步：数据库操作

文件： MySQL 数据库
表名： customers
执行的 SQL：

```sql
SELECT * FROM customers WHERE deleted_flag = 0 ORDER BY created_at DESC
```

5.1 结果集映射

```java
// CustomerDAO.java:201-227 (mapResultSetToCustomer 方法)
private Customer mapResultSetToCustomer(ResultSet rs) throws SQLException {
Customer customer = new Customer();
customer.setId(rs.getInt("id"));
customer.setCustomerCode(rs.getString("customer_code"));
customer.setFirstName(rs.getString("first_name"));
customer.setLastName(rs.getString("last_name"));
// ... 设置其他字段
return customer;
}
```

第 6 步：Model 数据模型

文件： src/main/java/com/insurance/model/Customer.java

6.1 数据模型定义

```java
// Customer.java:8-31 (Customer 类定义)
public class Customer {
private int id;
private String customerCode;
private String firstName;
private String lastName;
// ... 其他字段

      // Getter和Setter方法
      public int getId() { return id; }
      public void setId(int id) { this.id = id; }
      // ... 其他getter/setter

}
```

第 7 步：返回数据传递

执行流程：

```text
1. DAO 层返回 List<Customer>给 Service 层
2. Service 层返回 List<Customer>给 Servlet 层
3. Servlet 层将数据存入 request.setAttribute("customers", customers)
```

第 8 步：JSP 视图渲染

文件： src/main/webapp/WEB-INF/views/customer/list.jsp
8.1 JSP 页面渲染

```jsp
<%-- list.jsp:1-4 --%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jstl/fmt" %>

<%-- list.jsp:48-50 (表格渲染) --%>

  <div class="table-container">
      <table class="data-table">
          <thead>
              <tr>
                  <th>ID</th>
                  <th>顧客コード</th>
                  <th>氏名</th>
                  <th>性別</th>
                  <th>年齢</th>
                  <th>電話番号</th>
                  <th>メールアドレス</th>
                  <th>操作</th>
              </tr>
          </thead>
          <tbody>
              <c:forEach items="${customers}" var="customer">
                  <tr>
                      <td>${customer.id}</td>
                      <td>${customer.customerCode}</td>
                      <td>${customer.lastName} ${customer.firstName}</td>
                      <td>${customer.gender == 'M' ? '男性' : '女性'}</td>
                      <td>${customer.age}歳</td>
                      <td>${customer.phoneNumber}</td>
                      <td>${customer.email}</td>
                      <td>
                          <a href="customer?action=view&id=${customer.id}">詳細</a>
                          <a href="customer?action=edit&id=${customer.id}">編集</a>
                      </td>
                  </tr>
              </c:forEach>
          </tbody>
      </table>
  </div>
```

第 9 步：响应返回用户

文件： Tomcat 服务器处理
流程：

1. JSP 页面渲染完成，生成 HTML
2. Tomcat 服务器将 HTML 响应返回给浏览器
3. 浏览器解析并显示顾客列表页面

完整执行顺序总结

```txt

| 步骤 | 层级           | 文件                 | 主要方法                 | 功能           |
| ---- | -------------- | -------------------- | ------------------------ | -------------- |
| 1    | 用户浏览器     | -                    | HTTP GET                 | 发起请求       |
| 2    | Servlet 控制器 | CustomerServlet.java | doGet()→listCustomers()  | 请求路由和处理 |
| 3    | Service 业务层 | CustomerService.java | getAllCustomers()        | 业务逻辑处理   |
| 4    | DAO 数据访问层 | CustomerDAO.java     | getAllCustomers()        | 数据库操作     |
| 5    | 数据库工具     | DatabaseUtil.java    | getConnection()          | 数据库连接     |
| 6    | 数据库         | MySQL                | SQL 查询                 | 数据存储       |
| 7    | 数据模型       | Customer.java        | mapResultSetToCustomer() | 数据封装       |
| 8    | JSP 视图       | list.jsp             | JSTL 渲染                | 页面生成       |
| 9    | 服务器         | Tomcat               | HTTP 响应                | 返回结果       |
```

这个流程清晰地展示了传统 Java Web 应用的 MVC 架构模式，每个层次职责明确，便于理解和维护。
